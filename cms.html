<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin CMS | Project Manager</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-cms-app';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth;
        let userId = null;
        let isAuthReady = false;

        const log = (msg) => console.log(`[CMS] ${msg}`);

        // 1. Initialize Firebase
        window.initializeFirebase = async function() {
            const statusMsg = document.getElementById('authStatus');
            statusMsg.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Connecting...';
            statusMsg.className = "text-xs text-yellow-400 text-center mb-4";

            try {
                if (Object.keys(firebaseConfig).length === 0) {
                     if(window.location.protocol === 'file:') throw new Error("Cannot run locally via file://. Use a local server.");
                     throw new Error("Missing Firebase Configuration.");
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                try {
                    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                    else await signInAnonymously(auth);
                } catch (authErr) {
                    console.warn("Auth fallback...", authErr);
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        
                        // Enable buttons
                        document.getElementById('saveBtn').disabled = false;
                        document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save"></i> Save Project';
                        document.getElementById('saveBtn').classList.remove('opacity-50', 'cursor-not-allowed');
                        
                        document.getElementById('importBtn').disabled = false;
                        document.getElementById('importBtn').classList.remove('opacity-50', 'cursor-not-allowed');
                        
                        loadProjects();
                        statusMsg.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
                        statusMsg.className = "text-xs text-green-400 mt-2 font-bold";
                    } else {
                        statusMsg.innerText = "Disconnected";
                        statusMsg.className = "text-xs text-red-400 mt-2";
                    }
                });

            } catch (error) {
                console.error("Init Error:", error);
                statusMsg.innerHTML = "Connection Failed: " + error.message;
                statusMsg.className = "text-xs text-red-400 mt-2";
            }
        }

        // 2. Get DB Reference
        function getProjectsCollectionRef() {
            if (!db || !userId) return null;
            return collection(db, 'artifacts', appId, 'public', 'data', 'projects');
        }

        // 3. HANDLE SAVE
        window.handleProjectSubmit = async (e) => {
            e.preventDefault();
            if (!isAuthReady) return alert("Wait for connection...");

            const docId = document.getElementById('editDocId').value;
            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner animate-spin"></i> Saving...';

            try {
                const projectsRef = getProjectsCollectionRef();
                const data = {
                    title: document.getElementById('pTitle').value,
                    category: document.getElementById('pCategory').value,
                    img: document.getElementById('pImgUrl').value,
                    link: document.getElementById('pLink').value || '#',
                    description: document.getElementById('pDesc').value || '',
                    ownerId: userId,
                    timestamp: serverTimestamp(),
                };

                if (docId) await setDoc(doc(projectsRef, docId), data, { merge: true });
                else await setDoc(doc(projectsRef), data);
                
                showModal('Success', 'Project saved!');
                resetForm();
            } catch (error) {
                console.error(error);
                showModal('Error', 'Failed to save.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        // 4. LOAD PROJECTS
        function loadProjects() {
            const projectsRef = getProjectsCollectionRef();
            if (!projectsRef) return;
            const q = query(projectsRef, orderBy('timestamp', 'desc'));

            onSnapshot(q, (snapshot) => {
                const projects = [];
                snapshot.forEach(doc => projects.push({ docId: doc.id, ...doc.data() }));
                renderTable(projects);
            });
        }

        // 5. RENDER TABLE
        function renderTable(projects) {
            const tbody = document.getElementById('projectTableBody');
            tbody.innerHTML = '';

            if (projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No projects in database. Use "Import Sample Data" button.</td></tr>';
                return;
            }

            projects.forEach(p => {
                const isOwner = p.ownerId === userId;
                const safeTitle = (p.title || '').replace(/'/g, "\\'");
                const safeDesc = (p.description || '').replace(/'/g, "\\'");
                
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="p-3"><img src="${p.img}" class="w-12 h-12 object-cover rounded" onerror="this.src='https://placehold.co/50'"></td>
                    <td class="p-3 font-medium">${p.title}</td>
                    <td class="p-3"><span class="text-xs px-2 py-1 rounded-full ${p.category === 'arch' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">${p.category}</span></td>
                    <td class="p-3">
                        ${isOwner ? `
                        <button onclick="editProject('${p.docId}', '${safeTitle}', '${p.category}', '${p.link}', '${p.img}', '${safeDesc}')" class="text-yellow-600 hover:text-yellow-800 mr-2"><i class="fas fa-edit"></i></button>
                        <button onclick="confirmDelete('${p.docId}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                        ` : '<span class="text-xs text-gray-400">Read Only</span>'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 6. IMPORT DEFAULTS (NEW FEATURE)
        window.importDefaults = async () => {
            if(!isAuthReady) return;
            if(!confirm("This will add 5 sample projects to the database. Continue?")) return;
            
            const btn = document.getElementById('importBtn');
            btn.innerHTML = '<i class="fas fa-spinner animate-spin"></i> Importing...';
            btn.disabled = true;

            const defaults = [
                { title: "Modern Villa", category: "arch", img: "photo_5_2025-11-10_15-23-30.jpg", description: "A luxurious villa design emphasizing open spaces.", link: "project-villa.html" },
                { title: "Urban Complex", category: "arch", img: "dd15655392.png", description: "Mixed-use development combining residential units.", link: "project-urban.html" },
                { title: "Portfolio V1", category: "dev", img: "web-project-1.jpg", description: "Responsive personal portfolio with 3D animations.", link: "#" },
                { title: "Car Sales", category: "dev", img: "pr1.png", description: "A fully responsive functional business website.", link: "https://getachew-tsedeke-car-sales.42web.io/" },
                { title: "Real Estate App", category: "dev", img: "web-project-2.jpg", description: "Full-stack web application for renting real estate.", link: "#" }
            ];

            try {
                const projectsRef = getProjectsCollectionRef();
                const promises = defaults.map(p => {
                    const newDoc = doc(projectsRef);
                    return setDoc(newDoc, { ...p, ownerId: userId, timestamp: serverTimestamp() });
                });
                
                await Promise.all(promises);
                showModal("Success", "5 Projects imported successfully!");
            } catch(e) {
                console.error(e);
                showModal("Error", "Import failed: " + e.message);
            } finally {
                btn.innerHTML = 'Import Sample Data';
                btn.disabled = false;
            }
        };

        // 7. UTILS
        window.editProject = (id, title, cat, link, img, desc) => {
            document.getElementById('editDocId').value = id;
            document.getElementById('pTitle').value = title;
            document.getElementById('pCategory').value = cat;
            document.getElementById('pLink').value = link;
            document.getElementById('pImgUrl').value = img;
            document.getElementById('pDesc').value = desc;
            
            document.getElementById('formTitle').innerText = 'Edit Project';
            document.getElementById('saveBtn').innerHTML = '<i class="fas fa-sync-alt"></i> Update';
            document.getElementById('cancelBtn').classList.remove('hidden');
            updatePreview(img);
        };

        window.resetForm = () => {
            document.getElementById('projectForm').reset();
            document.getElementById('editDocId').value = '';
            document.getElementById('formTitle').innerText = 'Add New Project';
            document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save"></i> Save Project';
            document.getElementById('cancelBtn').classList.add('hidden');
            document.getElementById('imagePreviewBox').classList.add('hidden');
        };

        window.confirmDelete = (id) => {
            if(confirm('Delete permanently?')) deleteDoc(doc(getProjectsCollectionRef(), id));
        };

        window.updatePreview = (url) => {
            const box = document.getElementById('imagePreviewBox');
            if(url.length > 5) {
                box.classList.remove('hidden');
                document.getElementById('imgPreview').src = url;
            } else box.classList.add('hidden');
        }

        window.showModal = (t, b) => {
            document.getElementById('modalTitle').innerText = t;
            document.getElementById('modalBody').innerText = b;
            document.getElementById('customModal').classList.remove('hidden');
        }

        document.addEventListener('DOMContentLoaded', window.initializeFirebase);
    </script>
</head>
<body class="bg-gray-100 flex h-screen overflow-hidden font-sans">

    <!-- Sidebar -->
    <aside class="w-64 bg-[#013328] text-white flex flex-col p-6 shadow-xl z-20">
        <h2 class="text-2xl font-bold mb-8 border-b border-gray-700 pb-4 text-center">
            Pawlos.M <span class="text-sm text-[#f4a261]">CMS</span>
        </h2>
        <div id="authStatus" class="text-xs text-gray-400 text-center mb-4">Connecting...</div>
        <nav class="space-y-2">
            <a href="#" class="block p-3 rounded bg-gray-800 text-[#f4a261] font-bold">
                <i class="fas fa-project-diagram mr-2"></i> Projects
            </a>
            <a href="index.html" target="_blank" class="block p-3 rounded hover:bg-gray-700 text-gray-300 transition">
                <i class="fas fa-external-link-alt mr-2"></i> View Site
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8 overflow-y-auto relative">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Project Manager</h1>
            <!-- IMPORT BUTTON -->
            <button id="importBtn" onclick="importDefaults()" disabled class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow transition opacity-50 cursor-not-allowed">
                Import Sample Data
            </button>
        </header>

        <!-- Editor -->
        <div id="editorSection" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h3 id="formTitle" class="text-xl font-bold text-[#013328] mb-4 border-b pb-2">Add New Project</h3>
            
            <form id="projectForm" onsubmit="handleProjectSubmit(event)">
                <input type="hidden" id="editDocId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Project Title</label>
                        <input type="text" id="pTitle" required class="w-full p-2 border rounded focus:ring-2 focus:ring-[#f4a261] outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Category</label>
                        <select id="pCategory" class="w-full p-2 border rounded focus:ring-2 focus:ring-[#f4a261] outline-none">
                            <option value="arch">Architecture</option>
                            <option value="dev">Web Development</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Image URL</label>
                    <input type="text" id="pImgUrl" required oninput="updatePreview(this.value)" class="w-full p-2 border rounded focus:ring-2 focus:ring-[#f4a261] outline-none">
                    <div id="imagePreviewBox" class="hidden mt-2 p-2 bg-gray-50 border rounded text-center">
                        <img id="imgPreview" src="" class="h-32 mx-auto object-contain">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Link URL</label>
                    <input type="text" id="pLink" placeholder="#" class="w-full p-2 border rounded focus:ring-2 focus:ring-[#f4a261] outline-none">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Description</label>
                    <textarea id="pDesc" rows="3" class="w-full p-2 border rounded focus:ring-2 focus:ring-[#f4a261] outline-none"></textarea>
                </div>
                <div class="flex gap-3">
                    <button type="submit" id="saveBtn" disabled class="bg-[#013328] text-white px-6 py-2 rounded shadow hover:bg-green-900 transition opacity-50 cursor-not-allowed">
                        <i class="fas fa-spinner animate-spin"></i> Connecting...
                    </button>
                    <button type="button" id="cancelBtn" onclick="resetForm()" class="hidden bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600 transition">Cancel</button>
                </div>
            </form>
        </div>

        <!-- List -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold text-[#013328] mb-4">Current Projects</h3>
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-100">
                    <tr><th class="p-3">Image</th><th class="p-3">Title</th><th class="p-3">Category</th><th class="p-3">Actions</th></tr>
                </thead>
                <tbody id="projectTableBody">
                    <tr><td colspan="4" class="p-4 text-center text-gray-500">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Modal -->
    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded shadow-xl max-w-sm w-full">
            <h3 id="modalTitle" class="text-lg font-bold mb-2">Notice</h3>
            <p id="modalBody" class="text-gray-600 mb-4"></p>
            <div class="text-right">
                <button onclick="document.getElementById('customModal').classList.add('hidden')" class="bg-blue-600 text-white px-4 py-1 rounded">OK</button>
            </div>
        </div>
    </div>
</body>
</html>
