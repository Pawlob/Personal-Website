<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin CMS | Project Manager</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase (Compatible versions for this environment)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        // These variables are provided automatically by the environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-cms-app';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth;
        let userId = null;
        let isAuthReady = false;

        // Logging helper
        const log = (msg) => console.log(`[CMS] ${msg}`);

        // 1. Initialize Firebase
        window.initializeFirebase = async function() {
            const statusMsg = document.getElementById('authStatus');
            statusMsg.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Connecting...';
            statusMsg.className = "text-xs text-yellow-400 text-center mb-4";

            try {
                if (Object.keys(firebaseConfig).length === 0) {
                     // Diagnostic for missing config
                     if(window.location.protocol === 'file:') {
                        throw new Error("Cannot run locally via file://. Use a local server or Firebase Hosting.");
                     }
                     throw new Error("Missing Firebase Configuration.");
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authentication with Fallback
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (authErr) {
                    console.warn("Primary auth failed, trying anonymous fallback...", authErr);
                    await signInAnonymously(auth);
                }

                // Auth Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        log(`Logged in as ${userId}`);
                        
                        // ENABLE SAVE BUTTON
                        const btn = document.getElementById('saveBtn');
                        if(btn) {
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fas fa-save"></i> Save Project';
                            btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                        
                        // Load Data
                        loadProjects();
                        statusMsg.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
                        statusMsg.className = "text-xs text-green-400 mt-2 font-bold";
                    } else {
                        log("User logged out");
                        statusMsg.innerText = "Disconnected";
                        statusMsg.className = "text-xs text-red-400 mt-2";
                    }
                });

            } catch (error) {
                console.error("Init Error:", error);
                // Show detailed error in UI
                statusMsg.innerHTML = `
                    <div class="bg-red-900/30 p-2 rounded border border-red-800 text-left">
                        <div class="font-bold mb-1">Connection Failed</div>
                        <div class="text-[10px] opacity-75 break-words mb-2">${error.message}</div>
                        <button onclick="initializeFirebase()" class="text-[10px] bg-red-700 hover:bg-red-600 text-white px-2 py-1 rounded w-full">Retry</button>
                    </div>
                `;
                statusMsg.className = "text-xs text-red-400 mt-2";
            }
        }

        // 2. Get DB Reference
        function getProjectsCollectionRef() {
            if (!db || !userId) return null;
            return collection(db, 'artifacts', appId, 'public', 'data', 'projects');
        }

        // 3. HANDLE SAVE (Create/Update)
        window.handleProjectSubmit = async (e) => {
            e.preventDefault();
            
            if (!isAuthReady) {
                alert("Please wait for database connection...");
                return;
            }

            const docId = document.getElementById('editDocId').value;
            const btn = document.getElementById('saveBtn');
            const originalBtnText = btn.innerHTML;
            
            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner animate-spin"></i> Saving...';

            try {
                const projectsRef = getProjectsCollectionRef();
                
                const projectData = {
                    title: document.getElementById('pTitle').value,
                    category: document.getElementById('pCategory').value,
                    img: document.getElementById('pImgUrl').value,
                    link: document.getElementById('pLink').value || '#',
                    description: document.getElementById('pDesc').value || '',
                    ownerId: userId,
                    timestamp: serverTimestamp(), // SERVER TIMESTAMP
                };

                if (docId) {
                    // UPDATE existing
                    await setDoc(doc(projectsRef, docId), projectData, { merge: true });
                    showModal('Success', 'Project updated successfully!');
                } else {
                    // CREATE new
                    const newDocRef = doc(projectsRef); 
                    await setDoc(newDocRef, projectData);
                    showModal('Success', 'Project created successfully!');
                }
                
                resetForm();

            } catch (error) {
                console.error("Save Error:", error);
                showModal('Error', 'Failed to save. Check console for details.');
            } finally {
                // Restore button state
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
            }
        };

        // 4. LOAD PROJECTS (Realtime)
        function loadProjects() {
            const projectsRef = getProjectsCollectionRef();
            if (!projectsRef) return;

            const q = query(projectsRef, orderBy('timestamp', 'desc'));

            onSnapshot(q, (snapshot) => {
                const projects = [];
                snapshot.forEach(doc => projects.push({ docId: doc.id, ...doc.data() }));
                renderTable(projects);
            }, (err) => {
                console.error("Load Error:", err);
            });
        }

        // 5. RENDER TABLE
        function renderTable(projects) {
            const tbody = document.getElementById('projectTableBody');
            tbody.innerHTML = '';

            if (projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No projects found.</td></tr>';
                return;
            }

            projects.forEach(p => {
                const isOwner = p.ownerId === userId;
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                
                // Escape strings to prevent issues in onclick
                const safeTitle = (p.title || '').replace(/'/g, "\\'");
                const safeDesc = (p.description || '').replace(/'/g, "\\'");
                
                tr.innerHTML = `
                    <td class="p-3"><img src="${p.img}" class="w-12 h-12 object-cover rounded" onerror="this.src='https://placehold.co/50'"></td>
                    <td class="p-3 font-medium">${p.title}</td>
                    <td class="p-3"><span class="text-xs px-2 py-1 rounded-full ${p.category === 'arch' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">${p.category}</span></td>
                    <td class="p-3">
                        ${isOwner ? `
                        <button onclick="editProject('${p.docId}', '${safeTitle}', '${p.category}', '${p.link}', '${p.img}', '${safeDesc}')" class="text-yellow-600 hover:text-yellow-800 mr-2"><i class="fas fa-edit"></i></button>
                        <button onclick="confirmDelete('${p.docId}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                        ` : '<span class="text-xs text-gray-400">Read Only</span>'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 6. FORM ACTIONS
        window.editProject = (id, title, cat, link, img, desc) => {
            document.getElementById('editDocId').value = id;
            document.getElementById('pTitle').value = title;
            document.getElementById('pCategory').value = cat;
            document.getElementById('pLink').value = link;
            document.getElementById('pImgUrl').value = img;
            document.getElementById('pDesc').value = desc;
            
            document.getElementById('formTitle').innerText = 'Edit Project';
            document.getElementById('saveBtn').innerHTML = '<i class="fas fa-sync-alt"></i> Update';
            document.getElementById('cancelBtn').classList.remove('hidden');
            
            updatePreview(img);
            document.getElementById('editorSection').scrollIntoView({ behavior: 'smooth' });
        };

        window.resetForm = () => {
            document.getElementById('projectForm').reset();
            document.getElementById('editDocId').value = '';
            document.getElementById('formTitle').innerText = 'Add New Project';
            document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save"></i> Save Project';
            document.getElementById('cancelBtn').classList.add('hidden');
            document.getElementById('imagePreviewBox').classList.add('hidden');
        };

        window.confirmDelete = (id) => {
            if(confirm('Delete this project permanently?')) {
                const ref = doc(getProjectsCollectionRef(), id);
                deleteDoc(ref);
            }
        };

        // 7. UTILS
        window.updatePreview = (url) => {
            const box = document.getElementById('imagePreviewBox');
            const img = document.getElementById('imgPreview');
            if(url.length > 5) {
                box.classList.remove('hidden');
                img.src = url;
            } else {
                box.classList.add('hidden');
            }
        }
        
        window.clearAllData = async () => {
            if(confirm("DANGER: Delete ALL your projects?")) {
                // Implementation for clearing data if needed
                alert("Please delete items individually for safety.");
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', window.initializeFirebase);
    </script>
</head>
<body class="bg-gray-100 flex h-screen overflow-hidden font-sans">

    <!-- Sidebar -->
    <aside class="w-64 bg-[#013328] text-white flex flex-col p-6 shadow-xl z-20">
        <h2 class="text-2xl font-bold mb-8 border-b border-gray-700 pb-4 text-center">
            Pawlos.M <span class="text-sm text-[#f4a261]">CMS</span>
        </h2>
        <div id="authStatus" class="text-xs text-gray-400 text-center mb-4">Connecting...</div>
        <nav class="space-y-2">
            <a href="#" class="block p-3 rounded bg-gray-800 text-[#f4a261] font-bold">
                <i class="fas fa-project-diagram mr-2"></i> Projects
            </a>
            <a href="index.html" target="_blank" class="block p-3 rounded hover:bg-gray-700 text-gray-300 transition">
                <i class="fas fa-external-link-alt mr-2"></i> View Site
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8 overflow-y-auto relative">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Project Manager</h1>
        </header>

        <!-- Editor -->
        <div id="editorSection" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h3 id="formTitle" class="text-xl font-bold text-[#013328] mb-4 border-b pb-2">Add New Project</h3>
            
            <form id="projectForm" onsubmit="handleProjectSubmit(event)">
                <input type="hidden" id="editDocId">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Project Title</label>
                        <input type="text" id="pTitle" required class="w-full p-2 border rounded focus:ring-2 focus:ring-[#f4a261] outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Category</label>
                        <select id="pCategory" class="w-full p-2 border rounded focus:ring-2 focus:ring-[#f4a261] outline-none">
                            <option value="arch">Architecture</option>
                            <option value="dev">Web Development</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Image URL</label>
                    <div class="flex gap-2">
                        <input type="text" id="pImgUrl" required oninput="updatePreview(this.value)" placeholder="https://..." class="flex-1 p-2 border rounded focus:ring-2 focus:ring-[#f4a261] outline-none">
                    </div>
                    <div id="imagePreviewBox" class="hidden mt-2 p-2 bg-gray-50 border rounded text-center">
                        <img id="imgPreview" src="" class="h-32 mx-auto object-contain">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Link URL</label>
                    <input type="text" id="pLink" placeholder="#" class="w-full p-2 border rounded focus:ring-2 focus:ring-[#f4a261] outline-none">
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-1">Description</label>
                    <textarea id="pDesc" rows="3" class="w-full p-2 border rounded focus:ring-2 focus:ring-[#f4a261] outline-none"></textarea>
                </div>

                <div class="flex gap-3">
                    <button type="submit" id="saveBtn" disabled class="bg-[#013328] text-white px-6 py-2 rounded shadow hover:bg-green-900 transition opacity-50 cursor-not-allowed">
                        <i class="fas fa-spinner animate-spin"></i> Connecting...
                    </button>
                    <button type="button" id="cancelBtn" onclick="resetForm()" class="hidden bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600 transition">
                        Cancel
                    </button>
                </div>
            </form>
        </div>

        <!-- List -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold text-[#013328] mb-4">Current Projects</h3>
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-3 text-sm font-bold text-gray-600">Image</th>
                        <th class="p-3 text-sm font-bold text-gray-600">Title</th>
                        <th class="p-3 text-sm font-bold text-gray-600">Category</th>
                        <th class="p-3 text-sm font-bold text-gray-600">Actions</th>
                    </tr>
                </thead>
                <tbody id="projectTableBody">
                    <tr><td colspan="4" class="p-4 text-center text-gray-500">Loading database...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Modal (Simplified) -->
    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded shadow-xl max-w-sm w-full">
            <h3 id="modalTitle" class="text-lg font-bold mb-2">Notice</h3>
            <p id="modalBody" class="text-gray-600 mb-4"></p>
            <div class="text-right">
                <button onclick="document.getElementById('customModal').classList.add('hidden')" class="bg-blue-600 text-white px-4 py-1 rounded">OK</button>
            </div>
        </div>
    </div>
    <script>
        window.showModal = (t, b) => {
            document.getElementById('modalTitle').innerText = t;
            document.getElementById('modalBody').innerText = b;
            document.getElementById('customModal').classList.remove('hidden');
        }
    </script>
</body>
</html>